services:
  api-ralvarez-dev:
    build:
      context: ./api.ralvarez.dev
    hostname: api-ralvarez-dev
    ports:
      - "9000:80"

  internal-mailer:
    build:
      context: ./internal-mailer
      secrets:
        - GITHUB_TOKEN
    hostname: internal-mailer
    ports:
      - "9101:50051"
    environment:
      MODE: ${INTERNAL_MAILER_MODE}
      MAILERSEND_DOMAIN: ${INTERNAL_MAILER_MAILERSEND_DOMAIN}
      MAILERSEND_NAME: ${INTERNAL_MAILER_MAILERSEND_NAME}
      MAILERSEND_API_KEY: ${INTERNAL_MAILER_MAILERSEND_API_KEY}
      MAILERSEND_SENDER_NAME: ${INTERNAL_MAILER_MAILERSEND_SENDER_NAME}
      RESEND_DOMAIN: ${INTERNAL_MAILER_RESEND_DOMAIN}
      RESEND_NAME: ${INTERNAL_MAILER_RESEND_NAME}
      RESEND_API_KEY: ${INTERNAL_MAILER_RESEND_API_KEY}
      RESEND_SENDER_NAME: ${INTERNAL_MAILER_RESEND_SENDER_NAME}
      MAILER: ${INTERNAL_MAILER_MAILER}
    restart: on-failure
    networks:
      - app-network

  postgres:
    image: postgres:latest
    hostname: postgres
    volumes:
      - postgres-data:/var/lib/postgresql
      - ./postgres/initdb.d:/docker-entrypoint-initdb.d:ro
    environment:
      POSTGRES_USER: ${POSTGRES_SUPERUSER_NAME}
      POSTGRES_PASSWORD: ${POSTGRES_SUPERUSER_PASSWORD}
      POSTGRES_AUTH_DB_NAME: ${POSTGRES_AUTH_DB_NAME}
      POSTGRES_AUTH_DB_USER: ${POSTGRES_AUTH_DB_USER}
      POSTGRES_AUTH_DB_PASSWORD: ${POSTGRES_AUTH_DB_PASSWORD}
      POSTGRES_USER_DB_NAME: ${POSTGRES_USER_DB_NAME}
      POSTGRES_USER_DB_USER: ${POSTGRES_USER_DB_USER}
      POSTGRES_USER_DB_PASSWORD: ${POSTGRES_USER_DB_PASSWORD}
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U $POSTGRES_SUPERUSER_NAME && psql -U $POSTGRES_AUTH_DB_USER -d $POSTGRES_AUTH_DB_NAME -c '\\q' || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 20
    networks:
      - app-network

  mongodb:
      image: mongo:latest
      container_name: mongodb
      environment:
        MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
        MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
        INTERNAL_FILE_STORAGE_MONGODB_DB: ${INTERNAL_FILE_STORAGE_MONGODB_DB}
        INTERNAL_FILE_STORAGE_MONGODB_USERNAME: ${INTERNAL_FILE_STORAGE_MONGODB_USERNAME}
        INTERNAL_FILE_STORAGE_MONGODB_PASSWORD: ${INTERNAL_FILE_STORAGE_MONGODB_PASSWORD}
        MOVIES_MONGODB_DB: ${MOVIES_MONGODB_DB}
        MOVIES_MONGODB_USERNAME: ${MOVIES_MONGODB_USERNAME}
        MOVIES_MONGODB_PASSWORD: ${MOVIES_MONGODB_PASSWORD}
      ulimits:
        nofile:
          soft: 64000
          hard: 64000
      volumes:
        - mongodb-data:/data/db
        - ./mongodb/initdb.d:/docker-entrypoint-initdb.d:ro
      networks:
        - app-network
        
  redis:
    image: redis:latest
    hostname: redis
    volumes:
      - redis-data:/data
    command: 
      - redis-server
      - --aclfile
      - /data/users.acl
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
  
  redis-setup:
    image: redis:latest
    depends_on:
      redis:
        condition: service_healthy
    environment:
      REDIS_AUTH_USER: ${REDIS_AUTH_USER}
      REDIS_AUTH_PASSWORD: ${REDIS_AUTH_PASSWORD}
      REDIS_AUTH_DB: ${REDIS_AUTH_DB}
      REDIS_USER_USER: ${REDIS_USER_USER}
      REDIS_USER_PASSWORD: ${REDIS_USER_PASSWORD}
      REDIS_USER_DB: ${REDIS_USER_DB}
      REDIS_MOVIES_USER: ${REDIS_MOVIES_USER}
      REDIS_MOVIES_PASSWORD: ${REDIS_MOVIES_PASSWORD}
      REDIS_MOVIES_DB: ${REDIS_MOVIES_DB}
    command: ["/bin/sh", "/tmp/setup.sh"]  # ‚Üê Just use command
    volumes:
      - ./redis-setup/entrypoint.sh:/tmp/entrypoint.sh:ro
      - ./redis-setup/initdb.d:/docker-entrypoint-initdb.d:ro
    entrypoint: ["/bin/sh", "/tmp/entrypoint.sh"]
    networks:
      - app-network

  kafka:
    image: confluentinc/cp-kafka
    hostname: kafka
    environment:
      # KRaft settings
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9094
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      CLUSTER_ID: 2x8icf1ETEmIQ1v0AZ1GWA
            
      # Listeners with SASL (internal only)
      KAFKA_LISTENERS: SASL_PLAINTEXT://kafka:9092,CONTROLLER://kafka:9094
      KAFKA_ADVERTISED_LISTENERS: SASL_PLAINTEXT://kafka:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: SASL_PLAINTEXT:SASL_PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: SASL_PLAINTEXT
            
      # SASL Configuration - SCRAM
      KAFKA_SASL_ENABLED_MECHANISMS: SCRAM-SHA-256
      KAFKA_SASL_MECHANISM_INTER_BROKER_PROTOCOL: SCRAM-SHA-256
      KAFKA_OPTS: "-Djava.security.auth.login.config=/etc/kafka/kafka_jaas.conf"
                 
      # Enable ACLs (Authorization)
      KAFKA_AUTHORIZER_CLASS_NAME: org.apache.kafka.metadata.authorizer.StandardAuthorizer
      KAFKA_ALLOW_EVERYONE_IF_NO_ACL_FOUND: "true"  # Temporarily true to create users
      KAFKA_SUPER_USERS: User:${KAFKA_ADMIN_USERNAME}
            
      # Replication settings
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
            
      # Event Store: Infinite retention + Fast delivery
      KAFKA_NUM_NETWORK_THREADS: 8
      KAFKA_NUM_IO_THREADS: 8
      KAFKA_LINGER_MS: 0
      KAFKA_COMPRESSION_TYPE: lz4
      KAFKA_LOG_RETENTION_HOURS: -1
      KAFKA_LOG_RETENTION_BYTES: -1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "false"
    volumes:
      - kafka-data:/var/lib/kafka/data
      - ./kafka/config/kafka_jaas.conf:/etc/kafka/kafka_jaas.conf:ro
      - ./kafka/config/client.properties:/client.properties:ro
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "kafka:9092", "--command-config", "/client.properties"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 15s
    networks:
      - app-network

  kafka-setup:
    image: confluentinc/cp-kafka
    depends_on:
      kafka:
        condition: service_healthy
    environment:
      KAFKA_ADMIN_USERNAME: ${KAFKA_ADMIN_USERNAME}
      KAFKA_ADMIN_PASSWORD: ${KAFKA_ADMIN_PASSWORD}
      KAFKA_AUTH_USERNAME: ${KAFKA_AUTH_USERNAME}
      KAFKA_AUTH_PASSWORD: ${KAFKA_AUTH_PASSWORD}
      KAFKA_USER_USERNAME: ${KAFKA_USER_USERNAME}
      KAFKA_USER_PASSWORD: ${KAFKA_USER_PASSWORD}
      KAFKA_MOVIES_USERNAME: ${KAFKA_MOVIES_USERNAME}
      KAFKA_MOVIES_PASSWORD: ${KAFKA_MOVIES_PASSWORD}
    entrypoint: ["/bin/bash", "/docker-entrypoint-initdb.d/setup.sh"]
    volumes:
      - ./kafka-setup/initdb.d:/docker-entrypoint-initdb.d:ro
    networks:
      - app-network

secrets:
  GITHUB_TOKEN:
    file: ./.github_token

volumes:
  postgres-data:
  mongodb-data:
  redis-data:
  rabbitmq-data:
  kafka-data:

networks:
  app-network:
    driver: bridge
