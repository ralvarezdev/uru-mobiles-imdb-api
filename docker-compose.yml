services:
  api-ralvarez-dev:
    build:
      context: ./api.ralvarez.dev
    hostname: api-ralvarez-dev
    ports:
      - "9000:80"

  internal-mailer:
    build:
      context: ./internal-mailer
      secrets:
        - GITHUB_TOKEN
    hostname: internal-mailer
    ports:
      - "9101:50051"
    environment:
      # General Configuration
      MODE: ${INTERNAL_MAILER_MODE}
      
      # Server Configuration
      PORT: 50051

      # MailerSend Configuration
      MAILERSEND_DOMAIN: ${INTERNAL_MAILER_MAILERSEND_DOMAIN}
      MAILERSEND_NAME: ${INTERNAL_MAILER_MAILERSEND_NAME}
      MAILERSEND_API_KEY: ${INTERNAL_MAILER_MAILERSEND_API_KEY}
      MAILERSEND_SENDER_NAME: ${INTERNAL_MAILER_MAILERSEND_SENDER_NAME}

      # Resend Configuration
      RESEND_DOMAIN: ${INTERNAL_MAILER_RESEND_DOMAIN}
      RESEND_NAME: ${INTERNAL_MAILER_RESEND_NAME}
      RESEND_API_KEY: ${INTERNAL_MAILER_RESEND_API_KEY}
      RESEND_SENDER_NAME: ${INTERNAL_MAILER_RESEND_SENDER_NAME}

      # Selected Mailer
      MAILER: ${INTERNAL_MAILER_MAILER}
      
      # RabbitMQ Configuration
      RABBITMQ_URL: amqp://${RABBITMQ_INTERNAL_MAILER_USER}:${RABBITMQ_INTERNAL_MAILER_PASSWORD_ENCODED}@rabbitmq:5672/${RABBITMQ_DEFAULT_VHOST}
    
      # RabbitMQ mails exchange
      RABBITMQ_MAILS_EXCHANGE_NAME: ${RABBITMQ_MAILS_EXCHANGE_NAME}
      
      # RabbitMQ routing keys
      RABBITMQ_WELCOME_EMAILS_ROUTING_KEY: ${RABBITMQ_WELCOME_EMAILS_ROUTING_KEY}
      RABBITMQ_RESET_PASSWORD_EMAILS_ROUTING_KEY: ${RABBITMQ_RESET_PASSWORD_EMAILS_ROUTING_KEY}
      RABBITMQ_VERIFICATION_EMAILS_ROUTING_KEY: ${RABBITMQ_VERIFICATION_EMAILS_ROUTING_KEY}
      RABBITMQ_2FA_CODE_EMAILS_ROUTING_KEY: ${RABBITMQ_2FA_CODE_EMAILS_ROUTING_KEY}
    restart: on-failure
    networks:
      - app-network
      
  auth:
    build:
      context: ./auth
      secrets:
        - GITHUB_TOKEN
    hostname: auth
    ports:
      - "9001:50051" # Auth Service
      - "9102:50052" # Internal Auth Service
    environment:
      # Mode
      MODE: ${AUTH_MODE}
      
      # Admin credentials
      ADMIN_USERNAME: ${AUTH_ADMIN_USERNAME}
      ADMIN_EMAIL: ${AUTH_ADMIN_EMAIL}
      ADMIN_PASSWORD: ${AUTH_ADMIN_PASSWORD}
      
      # Server configuration
      DOMAIN: ${DOMAIN}
      PORT: 50051
      INTERNAL_PORT: 50052
      
      # Web App configuration
      VERIFY_EMAIL_URL: ${AUTH_VERIFY_EMAIL_URL}
      RESET_PASSWORD_URL: ${AUTH_RESET_PASSWORD_URL}
      
      # Postgres Connection
      POSTGRES_DSN: postgres://${POSTGRES_AUTH_DB_USER}:${POSTGRES_AUTH_DB_PASSWORD_ENCODED}@postgres:5432/${POSTGRES_AUTH_DB_NAME}?sslmode=disable
      POSTGRES_MAX_IDLE_CONNECTIONS: ${AUTH_POSTGRES_MAX_IDLE_CONNECTIONS}
      POSTGRES_MAX_OPEN_CONNECTIONS: ${AUTH_POSTGRES_MAX_OPEN_CONNECTIONS}

      # Redis Connection
      REDIS_ADDRESS: redis:6379
      REDIS_USERNAME: ${REDIS_AUTH_USER}
      REDIS_PASSWORD: ${REDIS_AUTH_PASSWORD}
      REDIS_DB: ${REDIS_TOKENS_DB}
      
      # JWT configuration
      JWT_ISSUER: ${DOMAIN}
      ACCESS_TOKEN_DURATION: ${ACCESS_TOKEN_DURATION}
      REFRESH_TOKEN_DURATION: ${REFRESH_TOKEN_DURATION}
      
      # RabbitMQ configuration
      RABBITMQ_URL: amqp://${RABBITMQ_AUTH_USER}:${RABBITMQ_AUTH_PASSWORD_ENCODED}@rabbitmq:5672/${RABBITMQ_DEFAULT_VHOST}
      RABBITMQ_MAILS_EXCHANGE_NAME: ${RABBITMQ_MAILS_EXCHANGE_NAME}
      RABBITMQ_WELCOME_EMAILS_ROUTING_KEY: ${RABBITMQ_WELCOME_EMAILS_ROUTING_KEY}
      RABBITMQ_RESET_PASSWORD_EMAILS_ROUTING_KEY: ${RABBITMQ_RESET_PASSWORD_EMAILS_ROUTING_KEY}
      RABBITMQ_VERIFICATION_EMAILS_ROUTING_KEY: ${RABBITMQ_VERIFICATION_EMAILS_ROUTING_KEY}
      RABBITMQ_2FA_CODE_EMAILS_ROUTING_KEY: ${RABBITMQ_2FA_CODE_EMAILS_ROUTING_KEY}

      # BCrypt configuration
      BCRYPT_COST: ${AUTH_BCRYPT_COST}
      
      # 2FA Email configuration
      TWO_FA_EMAIL_CODE_DURATION: ${AUTH_TWO_FA_EMAIL_CODE_DURATION}
      TWO_FA_EMAIL_CODE_LENGTH: ${AUTH_TWO_FA_EMAIL_CODE_LENGTH}
      
      # 2FA TOTP configuration
      TOTP_PERIOD: ${AUTH_TOTP_PERIOD}
      TOTP_DIGITS: ${AUTH_TOTP_DIGITS}
      TOTP_SECRET_LENGTH: ${AUTH_TOTP_SECRET_LENGTH}
      TOTP_RECOVERY_CODES_LENGTH: ${AUTH_TOTP_RECOVERY_CODES_LENGTH}
      TOTP_RECOVERY_CODES_COUNT: ${AUTH_TOTP_RECOVERY_CODES_COUNT}
      TOTP_ISSUER: ${DOMAIN}
      
      # Token configuration
      EMAIL_VERIFICATION_TOKEN_DURATION: ${AUTH_EMAIL_VERIFICATION_TOKEN_DURATION}
      RESET_PASSWORD_TOKEN_DURATION: ${AUTH_RESET_PASSWORD_TOKEN_DURATION}
      
      # Authentication configuration
      MINIMUM_PASSWORD_LENGTH: ${AUTH_MINIMUM_PASSWORD_LENGTH}
      MINIMUM_PASSWORD_SPECIAL_COUNT: ${AUTH_MINIMUM_PASSWORD_SPECIAL_COUNT}
      MINIMUM_PASSWORD_NUMBERS_COUNT: ${AUTH_MINIMUM_PASSWORD_NUMBERS_COUNT}
      MINIMUM_PASSWORD_CAPS_COUNT: ${AUTH_MINIMUM_PASSWORD_CAPS_COUNT}
      MAXIMUM_FAILED_ATTEMPTS_COUNT: ${AUTH_MAXIMUM_FAILED_ATTEMPTS_COUNT}
      MAXIMUM_FAILED_ATTEMPTS_PERIOD: ${AUTH_MAXIMUM_FAILED_ATTEMPTS_PERIOD}
    restart: on-failure
    volumes:
      - ./jwt/keys/private_key.pem:/app/config/private_key.pem:ro
      - ./jwt/keys/public_key.pem:/app/config/public_key.pem:ro
    networks:
      - app-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      
  user:
    build:
      context: ./user
      secrets:
        - GITHUB_TOKEN
    hostname: user
    ports:
      - "9002:50051"
    environment:
      # Mode
      MODE: ${USER_MODE}
      
      # Server configuration
      PORT: 50051
      AUTH_SERVICE_ADDRESS: auth:50051
      INTERNAL_AUTH_SERVICE_ADDRESS: auth:50052
      
      # Postgres Connection
      POSTGRES_DSN: postgres://${POSTGRES_USER_DB_USER}:${POSTGRES_USER_DB_PASSWORD_ENCODED}@postgres:5432/${POSTGRES_USER_DB_NAME}?sslmode=disable
      POSTGRES_MAX_IDLE_CONNECTIONS: ${USER_POSTGRES_MAX_IDLE_CONNECTIONS}
      POSTGRES_MAX_OPEN_CONNECTIONS: ${USER_POSTGRES_MAX_OPEN_CONNECTIONS}
      
      # Redis configuration
      REDIS_ADDRESS: redis:6379
      REDIS_USERNAME: ${REDIS_USER_USER}
      REDIS_PASSWORD: ${REDIS_USER_PASSWORD}
      REDIS_DB: ${REDIS_TOKENS_DB}
    restart: on-failure
    volumes:
      - ./jwt/keys/public_key.pem:/app/config/public_key.pem:ro
    networks:
      - app-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      auth:
        condition: service_started

  postgres:
    image: postgres:latest
    hostname: postgres
    volumes:
      - postgres-data:/var/lib/postgresql
      - ./postgres/initdb.d:/docker-entrypoint-initdb.d:ro
      - ./postgres/config/postgresql.conf:/etc/postgresql/postgresql.conf:ro
    environment:
      # Superuser
      POSTGRES_USER: ${POSTGRES_SUPERUSER_NAME}
      POSTGRES_PASSWORD: ${POSTGRES_SUPERUSER_PASSWORD}

      # Databases
      POSTGRES_AUTH_DB_NAME: ${POSTGRES_AUTH_DB_NAME}
      POSTGRES_USER_DB_NAME: ${POSTGRES_USER_DB_NAME}

      # Users
      POSTGRES_AUTH_DB_USER: ${POSTGRES_AUTH_DB_USER}
      POSTGRES_USER_DB_USER: ${POSTGRES_USER_DB_USER}

      # Passwords
      POSTGRES_AUTH_DB_PASSWORD: ${POSTGRES_AUTH_DB_PASSWORD}
      POSTGRES_USER_DB_PASSWORD: ${POSTGRES_USER_DB_PASSWORD}
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U $POSTGRES_SUPERUSER_NAME && psql -U $POSTGRES_AUTH_DB_USER -d $POSTGRES_AUTH_DB_NAME -c '\\q' || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 20
    networks:
      - app-network

  mongodb:
    image: mongo:latest
    container_name: mongodb
    environment:
      # Root User
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}

      # Databases
      INTERNAL_FILE_STORAGE_MONGODB_DB: ${INTERNAL_FILE_STORAGE_MONGODB_DB}
      MOVIES_MONGODB_DB: ${MOVIES_MONGODB_DB}

      # Users
      INTERNAL_FILE_STORAGE_MONGODB_USERNAME: ${INTERNAL_FILE_STORAGE_MONGODB_USERNAME}
      MOVIES_MONGODB_USERNAME: ${MOVIES_MONGODB_USERNAME}

      # Passwords
      INTERNAL_FILE_STORAGE_MONGODB_PASSWORD: ${INTERNAL_FILE_STORAGE_MONGODB_PASSWORD}
      MOVIES_MONGODB_PASSWORD: ${MOVIES_MONGODB_PASSWORD}
    ulimits:
      nofile:
        soft: 64000
        hard: 64000
    command: ["mongod", "--config", "/etc/mongod.conf"]
    healthcheck:
      test:
        [
          "CMD",
          "mongo",
          "--username",
          "${MONGO_INITDB_ROOT_USERNAME}",
          "--password",
          "${MONGO_INITDB_ROOT_PASSWORD}",
          "--eval",
          "db.adminCommand('ping')",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - mongodb-data:/data/db
      - ./mongodb/initdb.d:/docker-entrypoint-initdb.d:ro
      - ./mongodb/config/mongod.conf:/etc/mongod.conf:ro
    networks:
      - app-network

  redis:
    image: redis:latest
    hostname: redis
    volumes:
      - redis-data:/data
      - ./redis/config/redis.conf:/usr/local/etc/redis/redis.conf
      - ./redis/entrypoint.sh:/usr/local/bin/docker-entrypoint.sh:ro
      - ./redis/initdb.d:/docker-entrypoint-initdb.d:ro
    environment:
      # Root Password
      REDIS_DEFAULT_PASSWORD: ${REDIS_DEFAULT_PASSWORD}

      # Databases
      REDIS_TOKENS_DB: ${REDIS_TOKENS_DB}

      # Users
      REDIS_AUTH_USER: ${REDIS_AUTH_USER}
      REDIS_USER_USER: ${REDIS_USER_USER}
      REDIS_MOVIES_USER: ${REDIS_MOVIES_USER}

      # Passwords
      REDIS_AUTH_PASSWORD: ${REDIS_AUTH_PASSWORD}
      REDIS_USER_PASSWORD: ${REDIS_USER_PASSWORD}
      REDIS_MOVIES_PASSWORD: ${REDIS_MOVIES_PASSWORD}
    command:
      [
        "redis-server",
        "/usr/local/etc/redis/redis.conf",
        "--requirepass",
        "${REDIS_DEFAULT_PASSWORD}",
        "--aclfile",
        "/data/users.acl",
        "--loglevel",
        "warning",
      ]
    entrypoint: ["/bin/sh", "/usr/local/bin/docker-entrypoint.sh"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - app-network

  rabbitmq:
    image: rabbitmq:3-management
    hostname: rabbitmq
    ports:
      - "15672:15672" # Management UI
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
      - ./rabbitmq/entrypoint.sh:/usr/local/bin/docker-entrypoint.sh:ro
      - ./rabbitmq/initdb.d:/docker-entrypoint-initdb.d:ro
    environment:
      # Logs
      RABBITMQ_LOGS: "/var/log/rabbitmq/rabbitmq.log"
      RABBITMQ_LOG_LEVEL: "warning"

      # Default User
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASSWORD}

      # Default VHost
      RABBITMQ_DEFAULT_VHOST: ${RABBITMQ_DEFAULT_VHOST}

      # Users
      RABBITMQ_AUTH_USER: ${RABBITMQ_AUTH_USER}
      RABBITMQ_MOVIES_USER: ${RABBITMQ_MOVIES_USER}
      RABBITMQ_INTERNAL_MAILER_USER: ${RABBITMQ_INTERNAL_MAILER_USER}

      # Passwords
      RABBITMQ_AUTH_PASSWORD: ${RABBITMQ_AUTH_PASSWORD}
      RABBITMQ_MOVIES_PASSWORD: ${RABBITMQ_MOVIES_PASSWORD}
      RABBITMQ_INTERNAL_MAILER_PASSWORD: ${RABBITMQ_INTERNAL_MAILER_PASSWORD}

      # Exchanges
      RABBITMQ_USERNAMES_EXCHANGE_NAME: ${RABBITMQ_USERNAMES_EXCHANGE_NAME}
      RABBITMQ_MAILS_EXCHANGE_NAME: ${RABBITMQ_MAILS_EXCHANGE_NAME}
    entrypoint: ["/bin/sh", "/usr/local/bin/docker-entrypoint.sh"]
    healthcheck:
      test: rabbitmq-diagnostics -q ping && rabbitmq-diagnostics -q check_port_connectivity
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 40s
    networks:
      - app-network

  kurrentdb:
    build:
      context: ./kurrentdb
      args:
        BASE_TAG: ${KDB_ARCH_TAG} # experimental-arm64v8 for ARM64, latest for x86_64
    hostname: kurrentdb
    ports:
      - "2113:2113" # Default client port (gRPC and HTTP Admin UI)
    environment:
      # Logging, not sure if this is the correct variable
      KURRENTDB_LOG_LEVEL: Warning 
      
      # Admin Credentials
      KURRENTDB_DEFAULT_ADMIN_PASSWORD: ${KURRENTDB_ADMIN_PASSWORD}
    command: [
        # "${KURRENTDB_INSECURE}",
        "--certificate-file=/certs/node.crt",
        "--certificate-private-key-file=/certs/node.key",
        "--run-projections=All", # Enable projections
        "--start-standard-projections", # Start standard projections
        "--enable-atom-pub-over-http", # Enable HTTP API
        "--cluster-size=1", # Single node cluster
      ]
    volumes:
      - kurrentdb-data:/var/lib/kurrentdb/
      - kurrentdb-logs:/var/log/kurrentdb/
      - ./kurrentdb/certs:/certs:ro
    networks:
      - app-network

  kurrentdb-setup:
    build:
      context: ./kurrentdb-setup
    depends_on:
      kurrentdb:
        condition: service_healthy
    environment:
      # Connection
      KURRENTDB_SCHEME: https
      KURRENTDB_HOST: kurrentdb
      KURRENTDB_PORT: 2113
      KURRENTDB_ADMIN_USERNAME: ${KURRENTDB_ADMIN_USERNAME}
      KURRENTDB_ADMIN_PASSWORD: ${KURRENTDB_ADMIN_PASSWORD}
      CURL_OPTS: "-k"

      # Usernames
      KURRENTDB_AUTH_USERNAME: ${KURRENTDB_AUTH_USERNAME}
      KURRENTDB_MOVIES_USERNAME: ${KURRENTDB_MOVIES_USERNAME}

      # Passwords
      KURRENTDB_AUTH_PASSWORD: ${KURRENTDB_AUTH_PASSWORD}
      KURRENTDB_MOVIES_PASSWORD: ${KURRENTDB_MOVIES_PASSWORD}

      # Stream Names
      KURRENTDB_USERNAMES_STREAM: ${KURRENTDB_USERNAMES_STREAM}
    volumes:
      - ./kurrentdb-setup/initdb.d:/docker-entrypoint-initdb.d:ro
    networks:
      - app-network

secrets:
  GITHUB_TOKEN:
    file: ./.github_token

volumes:
  postgres-data:
  mongodb-data:
  redis-data:
  rabbitmq-data:
  kurrentdb-data:
  kurrentdb-logs:

networks:
  app-network:
    driver: bridge
