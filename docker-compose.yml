services:
  api-ralvarez-dev:
    build:
      context: ./api.ralvarez.dev
    hostname: api-ralvarez-dev
    ports:
      - "9000:80"

  internal-mailer:
    build:
      context: ./internal-mailer
      secrets:
        - GITHUB_TOKEN
    hostname: internal-mailer
    ports:
      - "9101:50051"
    environment:
      MODE: ${INTERNAL_MAILER_MODE}
      MAILERSEND_DOMAIN: ${INTERNAL_MAILER_MAILERSEND_DOMAIN}
      MAILERSEND_NAME: ${INTERNAL_MAILER_MAILERSEND_NAME}
      MAILERSEND_API_KEY: ${INTERNAL_MAILER_MAILERSEND_API_KEY}
      MAILERSEND_SENDER_NAME: ${INTERNAL_MAILER_MAILERSEND_SENDER_NAME}
      RESEND_DOMAIN: ${INTERNAL_MAILER_RESEND_DOMAIN}
      RESEND_NAME: ${INTERNAL_MAILER_RESEND_NAME}
      RESEND_API_KEY: ${INTERNAL_MAILER_RESEND_API_KEY}
      RESEND_SENDER_NAME: ${INTERNAL_MAILER_RESEND_SENDER_NAME}
      MAILER: ${INTERNAL_MAILER_MAILER}
    restart: on-failure
    networks:
      - app-network

  postgres:
    image: postgres:latest
    hostname: postgres
    volumes:
      - postgres-data:/var/lib/postgresql
      - ./postgres/initdb.d:/docker-entrypoint-initdb.d:ro
    environment:
      POSTGRES_USER: ${POSTGRES_SUPERUSER_NAME}
      POSTGRES_PASSWORD: ${POSTGRES_SUPERUSER_PASSWORD}
      POSTGRES_AUTH_DB_NAME: ${POSTGRES_AUTH_DB_NAME}
      POSTGRES_AUTH_DB_USER: ${POSTGRES_AUTH_DB_USER}
      POSTGRES_AUTH_DB_PASSWORD: ${POSTGRES_AUTH_DB_PASSWORD}
      POSTGRES_USER_DB_NAME: ${POSTGRES_USER_DB_NAME}
      POSTGRES_USER_DB_USER: ${POSTGRES_USER_DB_USER}
      POSTGRES_USER_DB_PASSWORD: ${POSTGRES_USER_DB_PASSWORD}
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U $POSTGRES_SUPERUSER_NAME && psql -U $POSTGRES_AUTH_DB_USER -d $POSTGRES_AUTH_DB_NAME -c '\\q' || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 20
    networks:
      - app-network

  mongodb:
    image: mongo:latest
    container_name: mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
      INTERNAL_FILE_STORAGE_MONGODB_DB: ${INTERNAL_FILE_STORAGE_MONGODB_DB}
      INTERNAL_FILE_STORAGE_MONGODB_USERNAME: ${INTERNAL_FILE_STORAGE_MONGODB_USERNAME}
      INTERNAL_FILE_STORAGE_MONGODB_PASSWORD: ${INTERNAL_FILE_STORAGE_MONGODB_PASSWORD}
      MOVIES_MONGODB_DB: ${MOVIES_MONGODB_DB}
      MOVIES_MONGODB_USERNAME: ${MOVIES_MONGODB_USERNAME}
      MOVIES_MONGODB_PASSWORD: ${MOVIES_MONGODB_PASSWORD}
    ulimits:
      nofile:
        soft: 64000
        hard: 64000
    volumes:
      - mongodb-data:/data/db
      - ./mongodb/initdb.d:/docker-entrypoint-initdb.d:ro
    networks:
      - app-network

  redis:
    image: redis:latest
    hostname: redis
    volumes:
      - redis-data:/data
      - ./redis/entrypoint.sh:/usr/local/bin/docker-entrypoint.sh:ro
      - ./redis/initdb.d:/docker-entrypoint-initdb.d:ro
    environment:
      REDIS_AUTH_USER: ${REDIS_AUTH_USER}
      REDIS_AUTH_PASSWORD: ${REDIS_AUTH_PASSWORD}
      REDIS_AUTH_DB: ${REDIS_AUTH_DB}
      REDIS_USER_USER: ${REDIS_USER_USER}
      REDIS_USER_PASSWORD: ${REDIS_USER_PASSWORD}
      REDIS_USER_DB: ${REDIS_USER_DB}
      REDIS_MOVIES_USER: ${REDIS_MOVIES_USER}
      REDIS_MOVIES_PASSWORD: ${REDIS_MOVIES_PASSWORD}
      REDIS_MOVIES_DB: ${REDIS_MOVIES_DB}
    command:
      [
        "redis-server",
        "--requirepass",
        "${REDIS_DEFAULT_PASSWORD}",
        "--aclfile",
        "/data/users.acl",
      ]
    entrypoint: ["/bin/sh", "/usr/local/bin/docker-entrypoint.sh"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - app-network

  rabbitmq:
    image: rabbitmq:3-management
    hostname: rabbitmq
    ports:
      - "15672:15672" # Management UI
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
      - ./rabbitmq/entrypoint.sh:/usr/local/bin/docker-entrypoint.sh:ro
      - ./rabbitmq/initdb.d:/docker-entrypoint-initdb.d:ro
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASSWORD}
      RABBITMQ_DEFAULT_VHOST: ${RABBITMQ_DEFAULT_VHOST}
      RABBITMQ_AUTH_USER: ${RABBITMQ_AUTH_USER}
      RABBITMQ_AUTH_PASSWORD: ${RABBITMQ_AUTH_PASSWORD}
      RABBITMQ_USER_USER: ${RABBITMQ_USER_USER}
      RABBITMQ_USER_PASSWORD: ${RABBITMQ_USER_PASSWORD}
      RABBITMQ_MOVIES_USER: ${RABBITMQ_MOVIES_USER}
      RABBITMQ_MOVIES_PASSWORD: ${RABBITMQ_MOVIES_PASSWORD}
      RABBITMQ_INTERNAL_MAILER_USER: ${RABBITMQ_INTERNAL_MAILER_USER}
      RABBITMQ_INTERNAL_MAILER_PASSWORD: ${RABBITMQ_INTERNAL_MAILER_PASSWORD}
      RABBITMQ_TOKENS_EXCHANGE_NAME: ${RABBITMQ_TOKENS_EXCHANGE_NAME}
      RABBITMQ_USERNAMES_EXCHANGE_NAME: ${RABBITMQ_USERNAMES_EXCHANGE_NAME}
      RABBITMQ_MAILS_EXCHANGE_NAME: ${RABBITMQ_MAILS_EXCHANGE_NAME}
    entrypoint: ["/bin/sh", "/usr/local/bin/docker-entrypoint.sh"]
    healthcheck:
      test: rabbitmq-diagnostics -q ping && rabbitmq-diagnostics -q check_port_connectivity
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 40s
    networks:
      - app-network

  kurrentdb:
    image: kurrentplatform/kurrentdb:latest
    container_name: kurrentdb_dev_node
    environment:
      KURRENTDB_INSECURE: ${KURRENTDB_INSECURE}

      # Enable projections (useful for querying by category/stream)
      KURRENTDB_RUN_PROJECTIONS: All
      KURRENTDB_START_STANDARD_PROJECTIONS:

      # Enable HTTP Atom Pub for the Admin UI Stream Browser
      KURRENTDB_ENABLE_ATOM_PUB_OVER_HTTP: true

      # Ensure it's running as a single node
      KURRENTDB_CLUSTER_SIZE: 1
    ports:
      - "2113:2113" # Default client port (gRPC and HTTP Admin UI)
    volumes:
      - kurrentdb-data:/var/lib/kurrentdb/
      - kurrentdb-logs:/var/log/kurrentdb/

secrets:
  GITHUB_TOKEN:
    file: ./.github_token

volumes:
  postgres-data:
  mongodb-data:
  redis-data:
  rabbitmq-data:
  kurrentdb-data:
  kurrentdb-logs:

networks:
  app-network:
    driver: bridge
